<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <!-- midi.js package -->
    <script src="./js/MIDI/AudioDetect.js" type="text/javascript"></script>
    <script src="./js/MIDI/LoadPlugin.js" type="text/javascript"></script>
    <script src="./js/MIDI/Plugin.js" type="text/javascript"></script>
    <script src="./js/MIDI/Player.js" type="text/javascript"></script>
    <script src="./js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
    <!-- extras -->
    <script src="./inc/Base64.js" type="text/javascript"></script>
    <script src="./inc/base64binary.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <style>
        #marker {
            width: 100px;
            padding: 0 10px;
            background: black;
            color: #00f;
            overflow: hidden;
            text-align: center;
            font-size: 2em;
            margin-bottom: 20px;
        }
        #marker .good {
            float: left;
            color: #0f0;
        }
        #marker .bad {
            float: right;
            color: #f00;
        }
    </style>
</head>

<body>
    <div id="marker">
        <div class="good">-</div>/
        <div class="bad">-</div>
    </div>
    <div id="feedback">Loading...</div><br>
    <button id="repeat" data-value="0">Repeat interval</button><br><br>
    <button class="button_interval" data-value="0">Prime</button>
    <button class="button_interval" data-value="1">Minor 2nd</button>
    <button class="button_interval" data-value="2">Major 2nd</button>
    <button class="button_interval" data-value="3">Minor 3rd</button>
    <button class="button_interval" data-value="4">Major 3rd</button>
    <button class="button_interval" data-value="5">Perfect 4th</button>
    <button class="button_interval" data-value="6">Tritone</button>
    <button class="button_interval" data-value="7">Perfect 5th</button>
    <button class="button_interval" data-value="8">Minor 6th</button>
    <button class="button_interval" data-value="9">Major 6th</button>
    <button class="button_interval" data-value="10">Minor 7th</button>
    <button class="button_interval" data-value="11">Major 7th</button>
    <button class="button_interval" data-value="12">Octave</button>
    
    <script type="text/javascript">
        var velocity = 127;
        var delay = 0.8;
        var baseNote = 0;
        var interval = 0;
        var good = 0;
        var bad = 0;
        
        $(document).ready(function() {
            MIDI.loadPlugin({
		        soundfontUrl: "./soundfont/",
		        instruments: [ "acoustic_grand_piano", "synth_drum" ],
		        callback: function() {
			        MIDI.programChange(0, 0); // Grand piano
			        MIDI.programChange(1, 118); // Synth drum
			        nextInterval();
			        $("#feedback").html("Select the interval");
			        updateMarker();
		        }
	        });
        });

        function updateMarker() {
            $("#marker .good").html(good);
			$("#marker .bad").html(bad);
        }

        function randInt(min, max) {
            return min + Math.floor(Math.random()*(max - min + 1));
        }

        function nextInterval() {
            baseNote = randInt(30, 60);
            interval = randInt(-12, 12);
            playInterval();
        }
        
        function playNote(note, delay, duration) {
            MIDI.noteOn(0, note, velocity, delay);
            MIDI.noteOff(0, note, delay + duration);
        }
        
        function playInterval() {
            playNote(baseNote, 0, delay);
            playNote(baseNote + interval, delay, delay);
        }
        
        $("#repeat").click(function() {
            playInterval();
        });
        
        $(".button_interval").click(function() {
            if (Math.abs(interval) == $(this).data("value")) {
                $("#feedback").html("Good!");
                good += 1;
                nextInterval();
            }
            else {
                $("#feedback").html("Wrong :(. Try again");
                bad += 1;
                playInterval();
            }
            updateMarker();
        });

    </script>
</body>
</html>
